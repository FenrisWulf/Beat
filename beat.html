<html>
<head>
<title>
Game
</title>
<style type="text/css">
</style>
<article>
  <div id="holder"></div> 
  <p id="status">File API &amp; FileReader API not supported</p>
  <p>Drag an image from your desktop on to the drop zone above to see the browser read the contents of the file and use it as the background - without uploading the file to any servers.</p>
</article>
<style>
#holder { border: 10px dashed #ccc; width: 300px; height: 300px; margin: 20px auto;}
#holder.hover { border: 10px dashed #333; }
</style>
<script type="text/javascript">

var source;
var context = new (window.AudioContext || window.webkitAudioContext)();
var processor;
var analyser;
var xhr;
var threshold = 0;
var beatDecayRate = .994;
var maxHoldTime = 5;
var holdTime = maxHoldTime;
function initAudio(data) {
    source = context.createBufferSource();
    
    if(context.decodeAudioData) {
        context.decodeAudioData(data, function(buffer) {
            source.buffer = buffer;
            createAudio();
        }, function(e) {
            console.log(e);
        });
    } else {
        source.buffer = context.createBuffer(data, false /*mixToMono*/);
        createAudio();
       }
    
    
}

function createAudio() {
    processor = context.createJavaScriptNode(2048 /*bufferSize*/, 1 /*num inputs*/, 1 /*num outputs*/); 
    processor.onaudioprocess = processAudio;

    analyser = context.createAnalyser();

    source.connect(context.destination);
    source.connect(analyser);

    analyser.connect(processor);
    processor.connect(context.destination);

    source.noteOn(0);
    setTimeout(disconnect, source.buffer.duration * 1000);
    
    
}
function getAverageVolume(array) {
        var values = 0;
        var average;
 
        var length = array.length;
 
        // get all the frequency amplitudes
        for (var i = 0; i < length; i++) {
            values += array[i];
        }
 
        average = values / length;
        return average;
    }
function disconnect() {
    source.noteOff(0);
    source.disconnect(0);
    processor.disconnect(0);
    analyser.disconnect(0);
}

function processAudio(e) {
    var freqByteData = new Uint8Array(analyser.frequencyBinCount);
    // get the average, bincount is fftsize / 2
    var array =  new Uint8Array(analyser.frequencyBinCount);
    analyser.getByteFrequencyData(array);
    var average = getAverageVolume(array);
    //console.log(average);
    holdTime--;
    if (holdTime <= 0) {
        if (average > threshold) {
            threshold = average;
            console.log("beat!");
            console.log(average);
            holdTime = maxHoldTime;
        }
        else {
            threshold *= beatDecayRate;
        }
    }
}

function dropEvent(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    
    var droppedFiles = evt.dataTransfer.files;
    
    var reader = new FileReader();
    
    reader.onload = function(fileEvent) {
        var data = fileEvent.target.result;
        initAudio(data);
    }
    
    reader.readAsArrayBuffer(droppedFiles[0]);
}

function handleResult() {
    if (xhr.readyState == 4 /* complete */) {
        switch(xhr.status) {
            case 200: /* Success */
                initAudio(request.response);
                break;
            default:
                break;
        }
        xhr = null;
    }      
}

function dragOver(evt) {
    evt.stopPropagation();
    evt.preventDefault();
    return false;
}

var dropArea = document.getElementById('holder');
dropArea.addEventListener('drop', dropEvent, false);
dropArea.addEventListener('dragover', dragOver, false);

</script>
</head>
<body>
<!-- Lets make a simple snake game -->
<canvas id="canvas" width="450" height="450"></canvas>

<!-- Jquery -->
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
</body>
</html>